# 进程间通信

## 常见问题

1. 一台机器最多能撑多少个TCP连接

   - 客户端，单个IP

     **当Linux作为客户端建立连接的时候，最大连接数量是受内核参数net.ipv4.ip_local_port_range限制** 而ip_local_port_range是可配置的，最大理论范围是0-65535

   - 多个IP地址

     **对于有1个Ip的客户端来说，受限于ip_local_port_range参数，也受限于65535。但单Linux可以配置多个ip，有几个ip，最大理论值就翻几倍**

     > 多张网卡不是必须的。即使只有一张网卡，也可以配置多ip。k8s就是这么干的，在k8s里，一台物理机上可以部署多个pod。但每一个pod都会被分配一个独立的ip，所以完全不用担心物理机上部署了过多的pod而影响你用的pod里的TCP连接数量。在ip给你的那一刻，你的pod就和其它应用隔离开了。

   - 服务端

     一条TCP连接是由一个四元组组成的。不考虑地址重用（unix的SO_REUSEADDR选项）的情况下，对于我们这台Nginx Server来说，它的IP和端口是固定的。cp连接4元组中只有remote ip（也就是client ip）和remote port（客户端port）是可变的。它可能建立的最大的连接数是2的32次方（ip数）×2的16次方（port数）

     - 一条TCP连接如果不发送数据的话，消耗内存是3.3K左右。如果有数据发送，需要为每条TCP分配发送缓存区，大小受你的参数net.ipv4.tcp_wmem配置影响，默认情况下最小是4K。如果发送结束，缓存区消耗的内存会被回收
     - 内存消耗一般是阈值限制，不需要考虑端口不够的情况
   
   - **TCP连接的客户端机：**每一个ip可建立的TCP连接理论受限于ip_local_port_range参数，也受限于65535。但可以通过配置多ip的方式来加大自己的建立连接的能力。
   
   - **TCP连接的服务器机：**每一个监听的端口虽然理论值很大，但这个数字没有实际意义。最大并发数取决你的内存大小，每一条静止状态的TCP连接大约需要吃3
     .3K的内存。

## 系统级I/O

### Unix I/O

所有的设备都被模型化为文件，所有的输入和输出都是对相应的文件的读写。

### 文件

#### 文件的类型

- 普通文件

  可以包含任意数据，文本文件是只含有ACSII或者Unicode字符的普通文件，二进制文件是所有其他的文件，内核角度看其实没区别

- 目录

  目录是包含一组链接的文件，每个链接都把一个文件名映射到一个文件，文件也可能是另一个目录。

- 套接字

  用来与另一个进程进行跨网络通信的文件。

还有命名通道等。。。



